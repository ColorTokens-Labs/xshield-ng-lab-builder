# Instructions to deploy agents

# One-time configuration

In this directory, execute:

```
./configure-ssh.sh
```

This retreives the Bastion IP and PEM filename from Terraform 

## Linux (Ubuntu)

Download the Ubuntu agent, and retrieve the deployment key from the Xshield console.  Then execute:

```
ansible-playbook -i linux-hosts -e agent_file=<agent_file_location> -e deployment_key=<deployment key> install-ubuntu-agent.yml
```

Accept the defaults for auto upgrade and vulnerability scanning.

## Windows Server

We need to administrator password of the Windows VMs.  Run this command to retrieve the password generated by Terraform:

```
terraform -chdir=../terraform output -raw password
```

We are using SSH tunneling via a Bastion, so run the following command in a second window to set up the tunnel.  Leave this session open.

```
ssh -F ssh-config bastion
```

Download the Windows server agent, and retrieve the deployment key from the Xshield console.

Now execute agent playbook:

```
ansible-playbook -i win-hosts -e agent_file=<agent_file_location> -e deployment_key=<deployment key> install-win-server-agent.yml -k -u administrator
```

Enter the passowrd you retrieved earlier.  If ansible crashes with an error (on macOS), execute this and try again:

```
export "OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES"
```


After the agents have been installed on all resources, you may logout of the bastion session.
